import AutoLinkFormat from "phaseclient/bbcode/autolink";
import TerrariaGlyphs from "phaseclient/bbcode/glyphs";
import Items from "phaseclient/bbcode/items";
import PhaseClient from "phaseclient/client";
import Discussion from "phaseclient/discussion";
import User from "phasecore/user";

const conversions = [
    // Text Style tags
    [
        /\[notag\](\[)(.*?)\[\/notag\]/i,
        "&#91;$2"
    ],
    [
        /\[b\](.*?)\[\/b\]/gi,
        "<b>$1</b>"
    ],
    [
        /\[i\](.*?)\[\/i\]/gi,
        "<i>$1</i>"
    ],
    [
        /\[u\](.*?)\[\/u\]/gi,
        "<u>$1</u>"
    ],
    [
        /\[ul\](.*?)\[\/ul\]/gi,
        "<ul>$1</ul>",
    ],
    [
        /\[li\](.*?)\[\/li\]/gi,
        "<li>$1</li>"
    ],
    [
        /\[s\](.*?)\[\/s\]/,
        '<span style="text-decoration:line-through;">$1</span>'
    ],
    [
        /\[img\](.*?)\[\/img\]/gi,
        '<a href="$1" target="_blank"><img class="post-image" src="$1" /></a>'
    ],
    [
        /\[url=(.*?)\](.*?)\[\/url\]/gi,
        '<a href="$1" target="_blank">$2</a>'
    ],
    [
        /\[url\](.*?)\[\/url\]/gi,
        "$1", // This is now handled by linkify
    ],
    [
        /\[center\](.*?)\[\/center\]/gi,
        '</p><p class="center">$1</p><p class="p_hbreak">'
    ],

    // ASCII
    [
        /&amp;#91;/gi,
        "[",
    ],

    // URL
    [
        // /((https:\/\/|http:\/\/)?(www\.)?([a-zA-Z0-9-](?:[a-zA-Z0-9-]|([.])(?!\5)){2,256}?)(\.[a-z]{2,4})(:\d+)?(\/(?:[^\s\n])*?)?(\?[^\s\n]+)?((?:\.(?:jpe?g|gif|png))|(?:\.(?:mp3|ogg|flac|wav)))?($|\s|\n|"|&quot;))/gi,
        /((https:\/\/|http:\/\/)?(www\.)?([a-zA-Z0-9-](?:[a-zA-Z0-9-]|([.])(?!\5)){2,256}?)(\.[a-z]{2,4})(:\d+)?(\/(?:[A-z0-9.\-\/])*?)?((?:\.(?:jpe?g|gif|png))|(?:\.(?:mp3|ogg|flac|wav)))?(\#.+)?)($|\s|\n|"|&quot;|\[|\])/gi,
        AutoLinkFormat
    ],

    // Emoji's
    [
        /\:\)/gi,
        '<img class="emoji" title=":)" src="https://dark-gaming.com/smileys/smile_face.gif" style="width: 15px">'
    ],
    [
        /\:\(/gi,
        '<img class="emoji" title=":(" src="https://dark-gaming.com/smileys/sad_face.gif" style="width: 15px">'
    ],
    [
        /\&gt\;:D/gi,
        '<img class="emoji" title=">&#58;D" src="https://dark-gaming.com/smileys/evil_face.gif" style="width: 15px">'
    ],
    [
        /\:D( |\.|,|$)/gi,
        '<img class="emoji" title=":D" src="https://dark-gaming.com/smileys/grin_face.gif" style="width: 15px">'
    ],
    [
        /\:P( |\.|,|$)/gi,
        '<img class="emoji" title=":P" src="https://dark-gaming.com/smileys/tongue_face.gif" style="width: 15px">'
    ],
    [
        /(^|\s);\)/gi,
        '$1<img class="emoji" title=";)" src="https://dark-gaming.com/smileys/wink_face.gif" style="width: 15px">'
    ],
    [
        /\(evil\)/gi,
        '<img class="emoji" title="(evil)" src="https://dark-gaming.com/smileys/evil_face.gif" style="width: 15px">'
    ],
    [
        /\(bash\)/gi,
        '<img class="emoji" title="(bash)" src="https://dark-gaming.com/smileys/bash_face.gif" style="width: 15px">'
    ],
    [
        /\(poolparty\)/gi,
        '<img class="emoji" title="(poolparty)" src="https://dark-gaming.com/smileys/poolparty.gif" style="width: 15px">'
    ],
    [
        /\(party\)/gi,
        '<img class="emoji" title="(party)" src="https://dark-gaming.com/smileys/party.gif" style="width: 15px">'
    ],
    [
        /\(hi\)/gi,
        '<img class="emoji" title="(hi)" src="https://dark-gaming.com/smileys/hi.gif" style="width: 15px">'
    ],
    [
        /\(knuckles\)/gi,
        '<img class="emoji" title="(knuckles)" src="https://dark-gaming.com/smileys/games_knuckles.gif" style="width: 15px">'
    ],
    [
        /\:O( |$|,|\.)/gi,
        '<img class="emoji" title=":O" src="https://dark-gaming.com/smileys/suprised_face.gif" style="width: 15px">'
    ],
    [
        /\\\o\//gi,
        '<img class="emoji" title="\o/" src="https://dark-gaming.com/smileys/duop.gif" style="width: 15px">'
    ],
    [
        /\[#(.*?)\]/gi,
        "&#$1;"
    ],
    [
        /\[color=(.*?)\](.*?)\[\/color\]/gi,
        '<span style="color:$1;">$2</span>'
    ],
    [
        /\[colour=(.*?)\](.*?)\[\/colour\]/gi,
        '<span style="color:$1;">$2</span>'
    ],
    [
        /:kappa:/gi,
        '<img class="emoji" title=":kappa:" src="https://t.dark-gaming.com:3001/img/kappa.png" style="width: 30px; height: 30px" />'
    ],
    [
        /:sushi:/gi,
        '<img class="emoji" title=":sushi:" src="https://t.dark-gaming.com:3001/img/sushi.png" style="width: 30px; height: 30px" />'
    ],
    [
        /:lol:/gi,
        '<img class="emoji" title=":lol:" src="https://t.dark-gaming.com:3001/img/lol.jpg" style="width: 30px; height: 30px" />'
    ],
    [
        /:troll:/gi,
        '<img class="emoji" title=":troll:" src="https://t.dark-gaming.com:3001/img/trollface.jpg" style="width: 30px; height: 30px" />'
    ],
    [
        /:chicken:/gi,
        '<img class="emoji" title=":chicken:" src="https://t.dark-gaming.com:3001/img/chicken.gif" style="width: 15px; height: 15px" />'
    ],
    [
        /:clap:/gi,
        '<img class="emoji" title=":clap:" src="https://emojipedia-us.s3.amazonaws.com/cache/97/d0/97d09f084fcdf1261ce9f518aeb4e55f.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:dansgame:/gi,
        '<img class="emoji" title=":dansgame:" src="https://i.imgur.com/bcsvuUH.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:minglee:/gi,
        '<img class="emoji" title=":minglee:" src="https://i.imgur.com/1wOePqF.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:lenny:/gi,
        '<img class="emoji" title=":lenny:" src="https://i.imgur.com/jzeVkdW.png" style="max-width: 25px; max-height: 25px;" />'
    ],
    [
        /:pogchamp:/gi,
        '<img class="emoji" title=":pogchamp:" src="https://i.imgur.com/cE4HXho.png" style="width: 30px; height: 30px;" />'
    ],
    [
        /:rip:/gi,
        '<img class="emoji" title=":rip:" src="https://i.imgur.com/yELemIR.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:pjsalt:/gi,
        '<img class="emoji" title=":pjsalt:" src="https://i.imgur.com/glgscpe.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:notlikethis:/gi,
        '<img class="emoji" title=":notlikethis:" src="https://i.imgur.com/nCE7WWV.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:wutface:/gi,
        '<img class="emoji" title=":wutface:" src="https://i.imgur.com/ThRkQt7.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:pepe:/gi,
        '<img class="emoji" title=":pepe:" src="https://i.imgur.com/eBcNp0e.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:heart:/gi,
        '<img class="emoji" title=":heart:" src="https://i.imgur.com/fIMf8f5.png" style="width: 25px; height: 25px;" />'
    ],
    [
        /:ok_hand:/gi,
        '<img class="emoji" title=":ok_hande:" src="https://i.imgur.com/PIIU0Pa.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:thinking:/gi,
        '<img class="emoji" title=":thinking:" src="https://i.imgur.com/ubNK73t.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:smile:/gi,
        '<img class="emoji" title=":smile:" src="https://i.imgur.com/DxLUYXO.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:yum:/gi,
        '<img class="emoji" title=":yum:" src="https://i.imgur.com/qRL0q2G.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:joy:/gi,
        '<img class="emoji" title=":joy:" src="https://i.imgur.com/01K0BM6.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:scream:/gi,
        '<img class="emoji" title=":scream:" src="https://i.imgur.com/86ysf2e.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:sob:/gi,
        '<img class="emoji" title=":sob:" src="https://i.imgur.com/9uzlWDA.png" style="width: 15px; height: 15px;" />'
    ],
    [
        /:thumbs_up:/gi,
        '<img class="emoji" title=":thumbs_up:" src="https://i.imgur.com/5UonQzw.png " style="width: 15px; height: 15px;" />'
    ],

    // Terraria Chat Tags
    [
        /\[i\/?(p\d+)?.*?(s\d+)?:(\d+)\]/g,
        (match, prefix, stack, capture) => {
            return `\
                <div class="terraria-item">\
                    <img
                        class="autoLinkedImage terraria-item-img"
                        src="https://t.dark-gaming.com/view/items_images/${Items.getItemImageNameFromID(capture - 1)}.png" />\
                    <span class="terraria-item-stack">${stack ? stack.substr(1) : ""}</span>\
                    <span class="terraria-item-name">${Items.getItemNameFromID(capture - 1)}</span>\
                    <div class="terraria-item-info">\
                    </div>\
                </div>\
            `;
        }
    ],

    [
        /\[g:(\d+)\]/g,
        (match, capture) => {
            return '<img class="autoLinkedImage terrariaItem" data-toggle="tooltip" data-placement="right" src="https://t.dark-gaming.com/img/' + TerrariaGlyphs.getGlyphImageNameFromID(capture) + '.png" />';
        }
    ],

    // Avatars
    [
        /\{avatar:(\d+)\}/g,
        ""
    ],

    // Markdown
    // Bold
    [
        /\*\*(.*?)\*\*/g,
        '<b>$1</b>'
    ],

    // Underline
    [
        /__(.*?)__/g,
        '<u>$1</u>'
    ],

    // Italics
    [
        /\*(.*?)\*/g,
        '<i>$1</i>'
    ],

    [
        /_(.*?)_($| )/g,
        '<i>$1</i>'
    ],

    // Strikethrough
    [
        /~~(.*?)~~/g,
        '<s>$1</s>'
    ],

    // Spoiler
    [
        /\|\|(.*?)\|\|/g,
        '<span class="md-spoiler-tag">$1</span>'
    ],

    // Multi-line ode
    [
        /```[\n\r](((.*?)[\n\r])+)```/gm,
        '<span class="md-multiline-code">$1</span>'
    ],

    // Inline code
    [
        /``(.*?)``/g,
        '<span class="md-inline-code">$1</span>'
    ],

    // Header 1
    [
        /^# (.*?)$/gm,
        '<span class="md-header-1">$1</span>'
    ],

    // Header 2
    [
        /^## (.*?)$/gm,
        '<span class="md-header-2">$1</span>'
    ],

    // Header 3
    [
        /^### (.*?)$/gm,
        '<span class="md-header-3">$1</span>'
    ],

    // Horizontal Rule
    [
        /^---$/gm,
        '<hr></hr>'
    ],

    // Bullet List
    [
        /^ \* +(.*)?/gm,
        '<ul><li>$1</li></ul>'
    ],

    [
        /(\<\/ul\>\n(.*)\<ul\>*)+/g,
        ''
    ],

    // @ Name
    [
        /@([^@]+?)(?=$|@)/gm,
        function(this: Discussion, match, haystack) {
            if (typeof this !== "undefined") {
                const everyone = haystack.indexOf("everyone");
                const here = haystack.indexOf("here");
                const user = this.members.reduce((t: null | User, v) => {
                    if (haystack.indexOf(v.name) === 0) {
                        if (t === null) {
                            t = v;
                        } else {
                            if (t.name.length < v.name.length) {
                                t = v;
                            }
                        }
                    }
                    return t;
                }, null);

                if (user !== null) {
                    return `<span class="user-mention">@${user.name}</span>${haystack.substr(user.name.length)}`;
                } else if (everyone === 0) {
                    return `<span class="user-mention">@everyone</span>${haystack.substr("everyone".length)}`;
                } else if (here === 0) {
                    return `<span class="user-mention">@here</span>${haystack.substr("here".length)}`;
                } else {
                    return match;
                }
            }
        }
    ],
];

export default conversions;
