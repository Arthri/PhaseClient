import Discussion from "phaseclient/discussion";
import Message from "phaseclient/message";
import ElementIdentifiers from "phaseweb/elementidentifiers";
import Client from "phaseweb/templates/client";

export default function LiveTypingMessage(client: Client, discussion: Discussion, message: Message) {
    const accountName = message.guestName.asIs().length > 0 && message.username.asIs().length > 0 ? message.username : "";
    const displayName = message.getDisplayName().getContentWithHtmlEscaped();
    const useSystemName = message.systemName !== client.systemName && message.systemName !== null;
    const systemName = message.systemName;
    const useTag = message.tag.length > 0;
    const tag = message.tag;
    const tagColour = message.tagColour;
    const chatMessage = message.getContentStyled();

    // Flags
    const isCreator = message.userId === discussion.creator;
    const isMod = discussion.moderators[message.userId];
    const isGuest = message.username.asIs().length === 0 && message.guestName.asIs().length > 0;

    const guestClass = isGuest ? ` ${ElementIdentifiers.Message.guest.substr(1)}` : "";
    const creatorClass = isCreator ? ` ${ElementIdentifiers.Message.creator.substr(1)}` : "";
    const modClass = isMod ? ` ${ElementIdentifiers.Message.moderator.substr(1)}` : "";
    const creatorOrModClass = isCreator ? creatorClass : modClass;

    return `
    <li class="in-progress" id="livetyping-user-${message.userId}">
        <div class="chat-message-avatar">
            <img class="avatar_${message.userId}"
                 src="${message.avatar}"
                 onError="this.onerror=null;this.src='https://t.dark-gaming.com:3001/img/question-mark.jpg';">
        </div>
        <div class="chat-message-right">
            <div class="chat-message-info">`
                    + `<span class="chat-name${creatorOrModClass}${guestClass}" title="${accountName}">${displayName}</span>`
                + `${(useSystemName ? `<span class="systemSuffix">@${systemName}</span>` : ``)}`
                + `${(useTag ? `<span style="margin-left: 5px; color: ${tagColour}">${tag}</span>` : ``)}`
            + `</div>
            <div class="chat-message-content"><div class="chat-line">${chatMessage}</div></div>
        </div>
        <div style="clear: both; content: ' '; height: 0"></div>
    </li>`;
}
