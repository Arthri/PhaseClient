import Discussion from "phaseclient/discussion";
import Message from "phaseclient/message";
import Client from "phaseweb/client";
import ElementIdentifiers from "phaseweb/elementidentifiers";

export default function LiveTypingMessage(client: Client, discussion: Discussion, message: Message) {
    const accountName = message.getGuestname().asIs().length > 0 && message.getUsername().asIs().length > 0 ? message.getUsername() : "";
    const displayName = message.getDisplayName().getContentWithHtmlEscaped();
    const useSystemName = message.getSystemName() !== client.getSystemName() && message.getSystemName() !== null;
    const systemName = message.getSystemName();
    const useTag = message.getTag().length > 0;
    const tag = message.getTag();
    const tagColour = message.getTagColour();
    const chatMessage = message.getContentStyled();

    // Flags
    const isCreator = message.getUserId() === discussion.getCreator();
    const isMod = discussion.getModerators()[message.getUserId()];
    const isGuest = message.getUsername().asIs().length === 0 && message.getGuestname().asIs().length > 0;

    const guestClass = isGuest ? ` ${ElementIdentifiers.Message.guest.substr(1)}` : "";
    const creatorClass = isCreator ? ` ${ElementIdentifiers.Message.creator.substr(1)}` : "";
    const modClass = isMod ? ` ${ElementIdentifiers.Message.moderator.substr(1)}` : "";
    const creatorOrModClass = isCreator ? creatorClass : modClass;

    return `
    <li class="in-progress" id="livetyping-user-${message.getUserId()}">
        <div class="chat-message-avatar">
            <img class="avatar_${message.getUserId()}"
                 src="${message.getAvatar()}"
                 onError="this.onerror=null;this.src='https://t.dark-gaming.com:3001/img/question-mark.jpg';">
        </div>
        <div class="chat-message-right">
            <div class="chat-message-info">`
                    + `<span class="chat-name${creatorOrModClass}${guestClass}" title="${accountName}">${displayName}</span>`
                + `${(useSystemName ? `<span class="systemSuffix">@${systemName}</span>` : ``)}`
                + `${(useTag ? `<span style="margin-left: 5px; color: ${tagColour}">${tag}</span>` : ``)}`
            + `</div>
            <div class="chat-message-content">${chatMessage}</div>
        </div>
        <div style="clear: both; content: ' '; height: 0"></div>
    </li>`;
}
