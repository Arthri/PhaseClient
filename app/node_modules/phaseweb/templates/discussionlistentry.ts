import Discussion from 'phaseclient/discussion';
import SafeString from 'phaseclient/safestring';
import ElementIdentifiers from 'phaseweb/elementidentifiers';
import DiscussionPreview from 'phaseweb/templates/discussionpreview';
import Client from 'phaseweb/client';

class DiscussionListEntry {
    private _discussion: Discussion;
    private _client: Client;
    private _cachedPreview: string = "";
    private _cachedMessageContent: string = "";

    constructor(client: Client, discussion: Discussion) {
        this._discussion = discussion;
        this._client = client;
    }

    public getContent() {
        let recentMessageContent = <SafeString> this._discussion.getRecentMessage().getContent();
        let isCurrentDiscussion = this._discussion.getIsBeingViewed();
        let hasUnreadMessages = this._discussion.getHasUnreadMessages();

        let currentDiscussionClass = isCurrentDiscussion ? ` ${ElementIdentifiers.DiscussionSection.selected.substr(1)}`: '';
        let unreadDiscussionClass = hasUnreadMessages && !isCurrentDiscussion ? ` ${ElementIdentifiers.DiscussionSection.unread.substr(1)}` : '';

        if (this._cachedPreview.length === 0 || recentMessageContent.asIs() !== this._cachedMessageContent) {
            this._cachedPreview = DiscussionPreview(this._client, this._discussion, this._discussion.getRecentMessage());
            this._cachedMessageContent = recentMessageContent.asIs();
        }

        return `
        <div class="discussion${currentDiscussionClass}${unreadDiscussionClass}" id="disc${this._discussion.getId()}">
            <div class="discussion-name">${this._discussion.getName().trim() || '[None]'}</div>
            <div class="spinner-container">
                <div class="spinner">
                    <div class="bounce1"></div>
                    <div class="bounce2"></div>
                    <div class="bounce3"></div>
                </div>
                <span style="display: none" class="discussion-alert glyphicon glyphicon-exclamation-sign"></span>
            </div>
            <div class="discussion-preview">${this._cachedPreview}</div>
        </div>`;
    }
}

export default DiscussionListEntry;