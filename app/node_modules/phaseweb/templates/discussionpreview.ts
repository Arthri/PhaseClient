import Discussion from "phaseclient/discussion";
import Message from "phaseclient/message";
import SafeString from "phaseclient/safestring";
import ElementIdentifiers from "phaseweb/elementidentifiers";
import Hash from "phaseweb/hash";
import Client from "phaseweb/templates/client";

function DiscussionPreview(client: Client, discussion: Discussion, message: Message) {
    const accountName = message.getGuestname().asIs().length > 0 && message.getUsername().asIs().length > 0 ? message.getUsername() : "";
    const displayName = message.getDisplayName().getContentWithHtmlEscaped();

    // Remove chat tags from name if they exist to "clean it up"
    const strippedName = displayName.replace(/\[(?:.*?):(.*?)]/, "$1");
    const nameWasStripped = strippedName !== displayName;
    const visualStrippedIcon = nameWasStripped ? `<span class="chat-name-asterisk" title="${displayName}">*</span>` : "";

    const useSystemName = message.getSystemName() !== client.getSystemName() && message.getSystemName() !== null;
    const systemName = message.getSystemName();
    const useTag = message.getTag().length > 0;
    const tag = message.getTag();
    const tagColour = message.getTagColour();
    const chatMessage = (message.getContent() as SafeString).withoutBbcodeAndHtml();

    // Flags
    const isCreator = message.getUserId() === discussion.getCreator();
    const isMod = discussion.getModerators()[message.getUserId()];
    const isGuest = message.getUsername().asIs().length === 0 && message.getGuestname().asIs().length > 0;

    const guestClass = isGuest ? ` ${ElementIdentifiers.Message.guest.substr(1)}` : "";
    const creatorClass = isCreator ? ` ${ElementIdentifiers.Message.creator.substr(1)}` : "";
    const modClass = isMod ? ` ${ElementIdentifiers.Message.moderator.substr(1)}` : "";
    const creatorOrModClass = isCreator ? creatorClass : modClass;

    const user = client.getPhaseUserByName(message.getUsername().asIs());
    const systemAvatar = `https://t.dark-gaming.com:3001/img/system_join.png`;

    let avatar: string;
    if (user) {
        avatar = user.getAvatar();
    } else if (message.getUserId() <= 0) {
        if (message.getTag().length) {
            avatar = `https://dark-gaming.com/img/default.png`;
        } else {
            avatar = systemAvatar;
        }
    } else {
        avatar = `https://t.dark-gaming.com:3001/img/question-mark.jpg`;
    }

    let avatarClass: string;
    if (user) {
        avatarClass = `avatar_hash${Hash(user ? user.getFormatName() : "")}`;
    } else {
        const prefix = message.getSystemName() !== client.getSystemName() ? `@${message.getSystemName()}` : ``;
        avatarClass = `avatar_hash${Hash(`${message.getUsername().asIs()}${prefix}`)}`;
    }

    return `
            <div class="chat-message-avatar">
                <img class="${avatarClass}" src="${avatar}"
                    onerror="this.onerror=null;this.src='https://t.dark-gaming.com:3001/img/question-mark.jpg';">
            </div>
            <div class="chat-message-right">
                <div class="${ElementIdentifiers.Message.info.substr(1)}">
                <span class="chat-name${creatorOrModClass}${guestClass}" title="${accountName}">${strippedName}${visualStrippedIcon}</span></div>
                <div class="chat-message-content">${chatMessage}</div>
            </div>
            <div style="clear: both; content: ' '; height: 0"></div>`;
}

export default DiscussionPreview;
