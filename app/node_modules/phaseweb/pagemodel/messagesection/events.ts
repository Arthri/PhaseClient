import $ from "jquery";
import { max } from "moment";
import DeepHistory from "phaseclient/deephistory";
import Discussion from "phaseclient/discussion";
import Message from "phaseclient/message";
import Search from "phaseclient/search";
import TextDifference from "phaseclient/textdifference";
import { EditQueueEntry } from "phasecore/editqueue";
import Client from "phaseweb/client";
import ElementIdentifiers from "phaseweb/elementidentifiers";
import MessageSection from "phaseweb/pagemodel/messagesection";

class MessageSectionEvents {
    private _messageSection: MessageSection;
    private _client: Client;

    constructor(messageSection: MessageSection, client: Client) {
        this._messageSection = messageSection;
        this._client = client;
        this.registerEvents();
    }

    private registerEvents(): void {
        this.registerMessageSend();
        this.registerTextInput();
        this.registerVideoThumbnailClick();
        this.registerAlertBellClick();
        this.registerScroll();
        this.registerSearchIconClick();
        this.registerSearchSubmit();
        this.registerTitleClick();
        this.registerMessageClick();
        this.registerLinkClick();
    }

    /**
     * Tells the client to take the necessary steps to send the message
     */
    private handleMessageSend(context: any): void {
        const chatText = $(context).val() as string;
        this._client.sendChatMessage(chatText);
        $(context).val("");
        this._messageSection.lastMessageInput = "";
    }

    /**
     * Registers the submit event of the chat message form for sending a message
     */
    private registerMessageSend(): void {
        const self = this;
        $(ElementIdentifiers.ChatInput.textInput).on("keydown", function(event) {
            if (event.keyCode === 13 && !event.shiftKey) {
                if (($(this).val() as string).length > 0) {
                    const scrollIsAtBottom = self._messageSection.getScrollIsAtBottom();
                    self.handleMessageSend(this);
                    $(this).text("");
                    this.style.height = "0px";
                    this.style.height = (this.scrollHeight) + "px";
                    self._messageSection.moveChatInputToBottom();
                    event.preventDefault();

                    if (scrollIsAtBottom) {
                        self._messageSection.scrollToBottom();
                    }
                }
            }
        });
    }

    private registerTextInput(): void {
        const self = this;
        $(ElementIdentifiers.ChatInput.textInput).on("input", function(event) {
            const scrollIsAtBottom = self._messageSection.getScrollIsAtBottom();
            const currentMessage = $(this).val() as string;

            if (currentMessage.length === 0) {
                self._messageSection.moveChatInputToBottom();
            } else if (self._messageSection.lastMessageInput.length === 0) {
                if (self._client.configuration.mergeLiveTypingWithCompleteChatArea) {
                    self._messageSection.moveChatInputToMessageList();
                }
            }

            let queue: EditQueueEntry[] | null = null;
            if (currentMessage.indexOf("/") === 0) {
                if (!self._messageSection.messageInputHadCommandPrefix) {
                    queue = TextDifference.getEditQueue(self._messageSection.lastMessageInput, "");
                }
            } else {
                if (self._messageSection.messageInputHadCommandPrefix) {
                    self._messageSection.messageInputHadCommandPrefix = false;
                    self._messageSection.lastMessageInput = "";
                }

                queue = TextDifference.getEditQueue(self._messageSection.lastMessageInput, currentMessage);
            }

            self._messageSection.lastMessageInput = currentMessage;

            if (queue !== null) {
                self._client.sendEditQueue(queue);
            }
            this.style.height = "0px";
            this.style.height = (this.scrollHeight) + "px";

            if (scrollIsAtBottom) {
                self._messageSection.scrollToBottom();
            }
        });
    }

    private registerVideoThumbnailClick(): void {
        const self = this;
        $(ElementIdentifiers.ChatSection.list).on("click", ElementIdentifiers.ChatSection.youtubePlayer, function() {
            self._messageSection.displayYoutubeVideo($(this));
        });
    }

    private registerAlertBellClick(): void {
        $(ElementIdentifiers.ChatSection.alertBell).on("click", () => {
            const currentDiscussion = this._client.currentDiscussion;

            if (typeof currentDiscussion !== "undefined") {
                this._client.toggleAlertsEnabled(currentDiscussion);
                this._messageSection.updateAlertBellStatus(currentDiscussion.alertsEnabled);
            }
        });
    }

    private registerScroll(): void {
        $(ElementIdentifiers.ChatSection.scrollSection).on("scroll", (e) => {
            const chatElement = $(ElementIdentifiers.ChatSection.scrollSection);
            const maximumScroll = chatElement[0].scrollHeight - chatElement[0].offsetHeight;
            const currentScroll = chatElement[0].scrollTop;

            if (currentScroll <= 400) {
                if (typeof this._client.currentDiscussion !== "undefined") {
                    this.handleScrolledTopDiscussion();
                } else if (this._client.discussionSearch !== null) {
                    this.handleScrolledTopSearch();
                } else if (this._client.deepHistory !== null) {
                    this.handleScrolledTopDeepHistory();
                }
            } else if (currentScroll >= maximumScroll - 200) {
                if (this._client.deepHistory !== null) {
                    this.handleScrolledBottomDeepHistory();
                }
            }
        });
    }

    /**
     * Handles when a user scrolled to the top of a discussions displayed messages
     */
    private handleScrolledTopDiscussion(): void {
        const discussion = this._client.currentDiscussion as Discussion;
        const messages = discussion.messages;
        if (messages.length > 40 && this._messageSection.displayedMessagesCount !== messages.length) {
            this._messageSection.displayOlderMessages();
        } else if (messages.length >= 40) {
            this._client.requestDiscussionHistory(discussion);
        }
    }

    /**
     * Handles when a user scrolled to the top of a searches displayed messages
     */
    private handleScrolledTopSearch(): void {
        const search = this._client.discussionSearch as Search;
        const discussion = search.discussion;
        if (this._messageSection.displayedMessagesCount >= 40 && !search.retrievalInProgress) {
            this._client.requestMessageSearch(search.terms, search.oldestId || undefined, search.username, search.systemName);
        }
    }

    private handleScrolledTopDeepHistory(): void {
        const deepHistory = this._client.deepHistory as DeepHistory;
        if (!deepHistory.retrievalInProgress && !deepHistory.obtainedOldest) {
            this._client.requestDiscussionDeepHistoryOlder();
        }
    }

    private handleScrolledBottomDeepHistory(): void {
        const deepHistory = this._client.deepHistory as DeepHistory;
        if (!deepHistory.retrievalInProgress) {
            this._client.requestDiscussionDeepHistoryNewer();
        }
    }

    /**
     * Handles when a user clicks on the search icon
     */
    private registerSearchIconClick(): void {
        const searchInput = $(ElementIdentifiers.ChatSection.messageSearchInput);
        $(ElementIdentifiers.ChatSection.messageSearch).on("click", () => {
            if (searchInput.css("display") !== "block") {
                searchInput.css("display", "block");
                searchInput.val("");
            }
            searchInput.focus();
        });

        $("body").on("click", (e) => {
            if ($(e.target).attr("id") !== ElementIdentifiers.ChatSection.messageSearchInput.substr(1)
                && $(e.target).attr("id") !== ElementIdentifiers.ChatSection.messageSearch.substr(1)) {
                searchInput.css("display", "none");
            }
        });
    }

    /**
     * Handles when a user submits the search form
     */
    private registerSearchSubmit(): void {
        const searchForm = $(ElementIdentifiers.ChatSection.messageSearchForm);
        const searchInput = $(ElementIdentifiers.ChatSection.messageSearchInput);
        searchForm.submit((e) => {
            e.preventDefault();
            const rawSearchContent = searchInput.val() as string;
            if (rawSearchContent.length > 0) {
                let searchContent = rawSearchContent;
                const usernameSeparator = rawSearchContent.lastIndexOf(" by:");
                let username: string | undefined;
                let systemName: string | undefined;
                if (usernameSeparator > -1) {
                    username = searchContent.substr(usernameSeparator + 4);
                    searchContent = searchContent.substr(0, usernameSeparator);
                    systemName = this._client.systemName;
                    const systemNameSeparator = username.lastIndexOf("@");
                    if (systemNameSeparator > -1) {
                        systemName = username.substr(systemNameSeparator + 1);
                        username = username.substr(0, systemNameSeparator);
                    }
                }

                this._client.requestMessageSearch(searchContent, undefined, username, systemName);
            }
        });
    }

    /**
     * Handles when a user clicks on the discussions title
     */
    private registerTitleClick(): void {
        const title = $(ElementIdentifiers.ChatSection.title);
        title.on("click", () => {
            // Doesn't already have an input field
            if (title.children().length === 0 && typeof this._client.currentDiscussion !== "undefined") {
                this._messageSection.enableDiscussionTitleEditMode();
            }
        });

        $("body").on("click", (e) => {
            if ($(e.target).parents(ElementIdentifiers.ChatSection.title).length === 0
                && $(e.target).attr("id") !== ElementIdentifiers.ChatSection.title.substr(1)) {
                if (title.children().length !== 0 && title.children().first().prop("tagName") === "input") {
                    // Avoid saving changes when current discussion is undefined.
                    // This is to ensure to add new discussion you MUST press enter not click out
                    const currentDiscussion = this._client.currentDiscussion;
                    if (typeof currentDiscussion !== "undefined") {
                        this._messageSection.saveTitleChanges();
                    }
                }
            }
        });
    }

    /**
     * Handles when a user clicks on a search result message
     */
    private registerMessageClick(): void {
        $(ElementIdentifiers.ChatSection.list).on("click", "li", (e) => {
            if (this._client.discussionSearch !== null) {
                const messageId = $(e.target).parents("li").first().attr("id") || $(e.target).attr("id");
                const message = this._client.discussionSearch.findMessage(messageId as string) as Message;
                this._client.requestDiscussionDeepHistory(this._client.discussionSearch.discussion, message);
            }
        });
    }

    private registerLinkClick(): void {
        const regex = /https:\/\/phase\.dark\-gaming\.com\/#messageref_([0-9]+?)($| )/i;
        $(ElementIdentifiers.ChatSection.list).on("click", "a", (e) => {
            const link = $(e.target).attr("href") as string;
            if (regex.test(link)) {
                const match = link.match(regex) as RegExpMatchArray;
                const messageId = parseInt(match[1]);
                this._client.requestMessageDeepHistory(messageId);
                e.preventDefault();
            }
        });
    }
}

export default MessageSectionEvents;
